// Financial Module Schema

// Account Management
model Account {
  id          String       @id @default(uuid())
  code        String       @unique
  name        String
  type        AccountType
  description String?
  balance     Decimal      @default(0)
  parentId    String?
  parent      Account?     @relation("AccountHierarchy", fields: [parentId], references: [id])
  children    Account[]    @relation("AccountHierarchy")
  level       Int         @default(0)
  status      String      @default("active")
  tenantId    String
  tenant      Tenant      @relation(fields: [tenantId], references: [id])
  transactions Transaction[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([tenantId])
  @@index([type])
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

model Transaction {
  id          String           @id @default(uuid())
  accountId   String
  account     Account          @relation(fields: [accountId], references: [id])
  type        TransactionType
  amount      Decimal
  description String
  reference   String?
  date        DateTime
  status      String          @default("pending")
  metadata    Json?
  tenantId    String
  tenant      Tenant          @relation(fields: [tenantId], references: [id])
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([tenantId])
  @@index([accountId])
  @@index([date])
}

enum TransactionType {
  DEBIT
  CREDIT
}

// Invoice Management
model Invoice {
  id          String        @id @default(uuid())
  number      String        @unique
  residentId  String
  resident    Resident      @relation(fields: [residentId], references: [id])
  status      InvoiceStatus @default(DRAFT)
  issueDate   DateTime
  dueDate     DateTime
  subtotal    Decimal
  tax         Decimal
  total       Decimal
  notes       String?
  metadata    Json?
  items       InvoiceItem[]
  payments    Payment[]
  tenantId    String
  tenant      Tenant        @relation(fields: [tenantId], references: [id])
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([tenantId])
  @@index([residentId])
  @@index([status])
  @@index([dueDate])
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
  VOID
}

model InvoiceItem {
  id          String   @id @default(uuid())
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id])
  description String
  quantity    Int
  unitPrice   Decimal
  taxRate     Decimal
  subtotal    Decimal
  tax         Decimal
  total       Decimal
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
  @@index([invoiceId])
}

// Payment Management
model Payment {
  id          String        @id @default(uuid())
  invoiceId   String
  invoice     Invoice       @relation(fields: [invoiceId], references: [id])
  amount      Decimal
  method      PaymentMethod
  status      PaymentStatus @default(PENDING)
  reference   String?
  date        DateTime
  metadata    Json?
  tenantId    String
  tenant      Tenant        @relation(fields: [tenantId], references: [id])
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([tenantId])
  @@index([invoiceId])
  @@index([status])
  @@index([date])
}

enum PaymentMethod {
  DIRECT_DEBIT
  CARD
  BANK_TRANSFER
  CASH
  CHECK
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

// Financial Settings
model FinancialSettings {
  id                    String    @id @default(uuid())
  tenantId             String    @unique
  tenant               Tenant    @relation(fields: [tenantId], references: [id])
  organizationName     String
  fiscalYearStart      String    // MM format
  defaultCurrency      String    // ISO currency code
  taxNumber            String?
  registrationNumber   String?
  invoicePrefix        String
  defaultDueDays       Int       @default(30)
  defaultTerms         String?
  defaultNotes         String?
  paymentMethods       PaymentMethod[]
  gatewayProvider      String?
  gatewayApiKey       String?   @db.Text
  gatewayWebhookSecret String?   @db.Text
  invoiceNotification  Boolean   @default(true)
  paymentNotification  Boolean   @default(true)
  overdueNotification  Boolean   @default(true)
  dataRetentionYears   Int       @default(7)
  vatEnabled          Boolean   @default(false)
  vatNumber           String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([tenantId])
}
